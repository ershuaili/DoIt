<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{commons::head(~{::title})}">
    <title>DoIt-Day</title>
</head>

<body class="hold-transition dark-mode sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed"
      onload="tasks()">
<div class="wrapper">
    <!-- 顶部导航栏 -->
    <nav th:replace="commons::commonNav(day)"></nav>
    <!-- 左侧导航栏 -->
    <aside th:replace="commons::commonMenu(day)"></aside>

    <!-- 中间内容 -->
    <div class="content-wrapper">
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <!-- /.row -->
                <div class="row">
                    <!-- 任务 -->
                    <div class="col-8">
                        <!-- 添加任务 -->
                        <form class="form-inline" id="taskInput" method="post">
                            <!--输入框-->
                            <label for="taskName"></label>
                            <input class="form-control input-lg" id="taskName" name="taskName" placeholder="添加任务"
                                   type="text">
                            <input id="endTime" name="endTime" type="button" value="选择结束日期">
                            <input class="btn btn-primary" id="taskBtn" type="button" value="提交"/>
                        </form>
                        <!--选择框-->
                        <div id="tasks">
                            <ul></ul>
                        </div>
                    </div>

                    <!-- 步骤 -->
                    <div class="col-4">
                        <!--添加步骤-->
                        <form class="form-inline" id="stepInput" method="post">
                            <!--输入框-->
                            <label for="step"></label>
                            <input class="form-control input-lg" id="step" name="content" placeholder="添加步骤"
                                   type="text">
                            <input class="btn btn-primary" id="stepBtn" type="button" value="提交"/>
                            <!--隐藏域父类id-->
                            <input id="taskId" name="taskId" type="hidden" value="">
                        </form>
                        <!--选择框-->
                        <div id="steps"></div>
                    </div>
                </div>
                <!-- /.row -->
            </div>
        </section>
        <!-- Main content -->
    </div>
    <!--/ 中间内容 -->
</div>

<div th:replace="commons::commonScript"></div>
<!--bootstrap日历控件-->
<script src="https://www.itxst.com/package/bootstrap-datepicker-1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://www.itxst.com/package/bootstrap-datepicker-1.9.0/locales/bootstrap-datepicker.zh-CN.min.js"></script>
<script>
    // 获取任务列表
    function tasks() {
        $.ajax({
            // 请求路径
            url: "/tasks",
            type: 'get',
            success: function (data) {
                // 拿到数据后执行的方法
                // console.log(data);
                let html = "";
                for (let i = 0; i < data.length; i++) {
                    html +=
                        "<li id=task value=" + data[i].id + ">" + data[i].taskName + " </li>" +
                        "<button value=" + data[i].id + ">删除</button>" + "<br>"
                }
                $("#tasks").html(html);
            }
        })
    }

    // 添加任务
    $("#taskBtn").click(function () {
        $.ajax({
            url: '/taskInput',
            type: 'post',
            async: false,
            // 获取数据发送给后端
            data: $('#taskInput').serialize(),
            success: function (data) {
                if (data === false) {
                    // 重新获取任务列表
                    tasks();
                    $("#taskName").val("")
                } else {
                    alert("添加失败")
                    tasks();
                }
            }
        });

    });

    // 删除任务
    $(function () {
        $("#tasks").on("click", "button", function () {

            $.ajax({
                url: "/taskDelete",
                type: "post",
                data: {id: $(this).val()},
                success: function () {
                    tasks();
                }
            })
        })
    });

    // 获取步骤列表
    // on可以动态创建元素绑定事件
    $(function () {
        $("#tasks").on("click", "li", function () {
            // 设置步骤的父级任务id
            document.getElementById('taskId').value = $(this).val();
            $.ajax({
                // 请求路径
                url: "/steps",
                type: 'get',
                // 方法回调将#name的值赋值给id
                // 取到当前的元素的value
                data: {id: $(this).val()},
                success: function (data) {
                    // 拿到数据后执行的方法
                    let html = "";
                    for (let i = 0; i < data.length; i++) {
                        html += data[i].content + "<a href='javascript:;'> 删除</a>" + "<br>"
                    }
                    $("#steps").html(html);
                }
            });
        });
    });

    // 添加步骤
    $("#stepBtn").click(function () {
        $.ajax({
            url: '/stepInput',
            type: 'post',
            async: false,
            data: $('#stepInput').serialize(),
            success: function (data) {
                if (data === false) {
                    // 将添加的元素加入到下面
                    $("#steps").append($("#step").val() + "<a href='javascript:;'> 删除</a>" + "<br>")
                    // 清空输入框
                    $('#step').val('');
                } else {
                    alert("添加失败")
                }
            }
        });
    });

    // 日历控件
    $("#endTime").datepicker({
        language: 'zh-CN', //语言
        autoclose: true, //选择后自动关闭
        clearBtn: true,//清除按钮
        format: "yyyy-mm-dd",//日期格式
        todayHighlight: true,//今天高亮
    });
</script>
</body>
</html>
